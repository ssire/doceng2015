/* ***** BEGIN LICENSE BLOCK *****
 *
 * Copyright (C) 2012 S. Sire
 *
 * This file contains files from the AXEL-FORMS extension to the Adaptable XML Editing Library (AXEL)
 * Version 0.1.1
 *
 * AXEL-FORMS is licensed by Oppidoc SARL 
 *
 * Web site : http://www.oppidoc.fr, https://bitbucket.org/ssire/axel-forms
 * 
 * Contributors(s) : S. Sire
 * 
 * ***** END LICENSE BLOCK ***** */
 (function(e){var f=0,g=0;var a={};var c={};var h={defaults:{},configure:function(j,k){this.defaults[j]=k},logError:function(k,j){e.error(k,j)},register:function(l,k,m){var j={factory:k};if(m){e.extend(j,m)}a[l]=j},getEditor:function(j){return c[j]}};function i(l,m){var k=$(l).attr("id")||("untitled"+(f++)),j=new a.transform.factory(k,l,m);xtiger.cross.log("debug",'registering editor "'+k+'"');c[k]=j;return j}function d(m,n){var l=$(m).attr("data-command"),k=$(m).attr("data-target")||("untitled"+(g++)),j=a[l];xtiger.cross.log("debug",'create command "'+l+'" on target "'+k+'"');if(j){if(j.check){if(e.command.getEditor(k)){if(m.disabled){m.disabled=false}new a[l].factory(k,m,n)}else{m.disabled=true;e.error("Missing or invalid data-target attribute in "+l+' command ("'+k+'")')}}else{new a[l].factory(k,m,n)}}else{e.error('Attempt to create an unkown command "'+l+'"')}xtiger.cross.log("debug",'created command "'+l+'" on target "'+k+'"')}function b(q,r,m){var l,t,k,j=r||q,o=m||r,s=[],p=[],n=[];xtiger.cross.log("debug","installing commands "+(r?"slice mode":"document mode"));k=r?"[data-template]":"* [data-template]";t=j;do{$(k,t).each(function(u,v){s.push(v)});t=r?t.nextSibling:undefined}while(t&&(t!==m)&&(o!=r));k="[data-command]";t=j;do{$(k,t).each(function(u,v){if($(v).attr("data-command")!=="transform"){p.push(v)}else{if(!$(v).attr("data-template")){s.push(v)}}});t=r?t.nextSibling:undefined}while(t&&(t!==m)&&(o!=r));if(h.defaults.bundlesPath){for(l=0;l<s.length;l++){n.push(i(s[l],q))}}else{if(s.length>0){e.error("Cannot start editing because AXEL bundles path is unspecified")}}for(l=0;l<p.length;l++){d(p[l],q)}return n}e.command=h;e.command.install=b;jQuery(function(){var j=$("script[data-bundles-path]").attr("data-bundles-path");if(j){h.configure("bundlesPath",j);e.filter.applyTo({optional:"input",event:"input"})}b(document)})}($axel));(function(h){var a={};var j={getDocument:function(){return this._doc},getParam:function(k){return this._param[k]||this._defaults[k]},getVariable:function(){return this._variable}};var c={_installError:function(k){this.errScope=k.attr("data-error-scope")||undefined;this.errSel="[data-"+this.getName()+'-error="'+this.getVariable()+'"]'},toggleError:function(n,l){var k,m,o=this.getDocument();if(!this.errScope){k=$("body "+this.errSel,o)}else{if(l){m=$(l,o).closest(this.errScope);k=$(this.errSel,m.get(0))}}if(k){if(n){k.hide()}else{k.show()}}return n}};function d(n,m,l){var k=new Function();k.prototype=(function(o){var p=o;return{getName:function(){return p}}}(n));h.extend(k.prototype,j);if(m&&m.error){h.extend(k.prototype,c)}k.prototype.onInstall=l.onInstall;h.extend(k.prototype,l.methods,false,true);return k}function g(q,o,t,s){var r,l,p="#"+o,m=s||".af-label",n=[],k=[];q.apply(function(B){var u=(B.getParam("required")==="true"),w=B.isValid,v=(B.getParam("required")!=="true")||B.isModified(),z=(!v)||(!B.isValid||B.isValid()),A=$(B.getHandle()),x=A.parents().children(m).first(),C,y;if(v&&u){A.removeClass("af-required");x.removeClass("af-required")}if(z&&w){A.removeClass("af-invalid");x.removeClass("af-invalid")}if((u||w)&&(!v||!z)){C=x.text();y=C.lastIndexOf(":");if(y!=-1){C=C.substr(0,y)}C=$.trim(C);if(!v&&u){A.addClass("af-required");x.addClass("af-required");n.push(C)}else{if(w){A.addClass("af-invalid");x.addClass("af-invalid");k.push(C)}}}});l=$(p,t).html("");if(n.length>0){l.append("<p>Vous devez remplir les champs suivants : "+n.join(", ")+"</p>")}if(k.length>0){l.append("<p>Vous devez corriger les champs suivants : "+k.join(", ")+"</p>")}r=(n.length===0)&&(k.length===0);if(!r){l.addClass("af-validation-failed")}else{l.removeClass("af-validation-failed")}return r}function b(l,k){if(l){if(typeof l.isValid==="function"){l.isValid.extend(k)}else{l.isValid=function(n){var o=[n];var m=function(){var q,p=true;for(var q=0;q<o.length;q++){p=p&&o[q](this)}return p};m.extend=function(p){o.push(p)};return m}(k)}}else{xtiger.cross.log("error","attempt to set a validator function on an undefined editor")}}function i(n,m,o,q){var p={},l=d(n,m,q);h.extend(p,o);a[n]={name:n,options:m,defaults:p,klass:l}}function e(t,u,q){var n,o,m,s,l={},p=true;var r=u.attr("data-variable");if(r){m=t.defaults;for(n in m){if(m.hasOwnProperty(n)){s=u.attr("data-"+n);if(s){l[n]=s}else{if(m[n]===h.binding.REQUIRED){xtiger.cross.log("error",'Missing attribute "data-'+n+'" to install "'+t.name+'" binding');p=false;break}}}}if(p){o=new t.klass();o._doc=q;o._variable=r;o._defaults=m;o._param=l;if(t.options&&t.options.error){o._installError(u)}o.onInstall(u);xtiger.cross.log("debug",'installed binding "'+t.name+'"');return o}}else{xtiger.cross.log("error",'Missing attribute "data-variable" to install "'+t.name+'" binding')}}function f(o,k,n){var p=k||o,l=n||k,m=k?"[data-binding]":"body [data-binding]";xtiger.cross.log("debug","installing bindings "+(k?"slice mode":"document mode"));do{$(m,p).each(function(q,u){var r,s=$(u),t=s.attr("data-binding").split(" ");for(r=0;r<t.length;r++){if(a[t[r]]){xtiger.cross.log("debug",'installing binding "'+t[r]+'"');e(a[t[r]],s,o)}else{xtiger.cross.log("error",'unregistered binding "'+t[r]+'"')}}});p=k?p.nextSibling:undefined}while(p&&(p!==n)&&(l!=k))}h.binding=h.binding||{};h.binding.list=function(){var k,l=[];for(k in a){l.push(k)}return l};h.binding.register=i;h.binding.install=f;h.binding.validate=g;h.binding.setValidation=b;h.binding.REQUIRED=1}($axel));(function(a){var b=(function(){function e(g){var f;if(g.indexOf("\\ ")===-1){return g.split(" ")}else{f=g.replace(/\\ /g,"&nbsp;");return xtiger.util.array_map(f.split(" "),function(h){return h.replace(/&nbsp;/g," ")})}}function c(n,r,k){var h,g,s,m=n.getHandle(),q=n.getDocument(),p=n.getParam("multiple")==="yes"?"checkbox":"radio",j=n.getParam("noedit")==="true"?'disabled="true" ':"",f=n.getUniqueKey(),l=n.getParam("appearance")==="full";for(h=0;h<r.length;h++){if(l){$(m).append("<li><label><input "+j+'type="'+p+'" value="'+r[h]+'" name ="'+f+'"/>'+k[h]+"</label></li>")}else{g=xtdom.createElement(q,"option");s=xtdom.createTextNode(q,k[h]);xtdom.setAttribute(g,"value",r[h]);if(n.getParam("noedit")==="true"){xtdom.setAttribute(g,"disabled",true)}g.appendChild(s);m.appendChild(g)}}}function d(f,g){var h=true;if(!f){if(typeof g==="string"){h=g!==f}else{if(!g||((g.length===1)&&!g[0])){h=false}}}return h}return{onGenerate:function(i,h,f){var g;if(this.getParam("appearance")==="full"){g=xtdom.createElement(f,"ul")}else{g=xtdom.createElement(f,"select")}xtdom.addClassName(g,"axel-choice");i.appendChild(g);return g},onInit:function(i,g,h){var f=this.getParam("values");if(this.getParam("hasClass")){xtdom.addClassName(this._handle,this.getParam("hasClass"))}if(this.getParam("multiple")==="yes"){$(this._handle).attr("multiple","multiple")}if(!h){c(this,this.getParam("values"),this.getParam("i18n"))}},onAwake:function(){var h=this,f=this.getDefaultData(),g=this.getParam("placeholder");if((this.getParam("appearance")!=="full")&&(g||(!f))){g=g||"";$(this._handle).prepend('<option class="axel-choice-placeholder" selected="selected" value="">'+(g||"")+"</option>");if(!f){this._param.values.splice(0,0,g);if(this._param.i18n!==this._param.values){this._param.i18n.splice(0,0,g)}if(g){$(this._handle).addClass("axel-choice-placeholder")}}}xtdom.addEventListener(this._handle,"change",function(i,j){if(!(j&&j.synthetic)){if(h.getParam("appearance")==="full"){var k=[];$("input",h.getHandle()).each(function(l,m){if(m.checked){k.push($(m).val())}});h.update(k)}else{h.update($(this).val())}}},true);this._setData(f)},onLoad:function(l,k){var j,g,i,f,h;if(k.isEmpty(l)){this.clear(false)}else{f=this.getParam("xvalue");g=this.getDefaultData();if(f){j=[];i=k.getVectorFor(f,l);while(i!==-1){h=k.getDataFor(i);if(h){j.push(h)}i=k.getVectorFor(f,l)}this._setData(j.length>0?j:"")}else{h=k.getDataFor(l);if(typeof h!=="string"){h=""}j=(h||g).split(",");this._setData(j)}this.set(false);this.setModified(d(g,j))}},onSave:function(g){var f,j,h;if((!this.isOptional())||this.isSet()){if(this._data&&(this._data!==this.getParam("placeholder"))){f=this.getParam("xvalue");if(f){if(typeof this._data==="string"){g.openTag(f);g.write(this._data);g.closeTag(f)}else{for(h=0;h<this._data.length;h++){if(this._data[h]!==""){g.openTag(f);g.write(this._data[h]);g.closeTag(f)}}}}else{g.write(this._data.toString().replace(/^,/,""))}}}else{g.discardNodeIfEmpty()}},api:{_parseFromTemplate:function(h){var i,g;this._param={};xtiger.util.decodeParameters(h.getAttribute("param"),this._param);g=xtdom.extractDefaultContentXT(h);i=h.getAttribute("option");this._option=i?i.toLowerCase():null;var f=h.getAttribute("values"),l=h.getAttribute("i18n"),k=f?e(f):["undefined"],j=l?e(l):undefined;this._param.values=k;this._param.i18n=j||k;this._content=g||""},isFocusable:function(){return true}},methods:{_setData:function(g,h){var f;if(this.getParam("appearance")!=="full"){if(!g&&(this.getParam("placeholder"))){$(this.getHandle()).addClass("axel-choice-placeholder")}else{$(this.getHandle()).removeClass("axel-choice-placeholder")}}this._data=g||"";if(!h){if(this.getParam("appearance")==="full"){f=typeof this._data==="string"?[this._data]:this._data;$("input",this.getHandle()).each(function(j,k){if($.inArray($(k).val(),f)>-1){k.checked=true;xtdom.removeClassName(k.parentNode,"axel-choice-unset")}else{k.checked=false;xtdom.addClassName(k.parentNode,"axel-choice-unset")}})}else{$(this.getHandle()).val(g)}}},dump:function(){return this._data},update:function(f){var g=d(this.getDefaultData(),f);this.setModified(g);this._setData(f,true);this.set(g)},clear:function(f){this._setData(this.getDefaultData());if(this.isOptional()){this.unset(f)}}}}}());a.plugin.register("choice",{filterable:true,optional:true},{choice:"value"},b);a.filter.applyTo({event:["choice"]})}($axel));(function(i){var j={};var a={};var g=function g(l,m){if(!j[l]){j[l]={}}j[l][m]=true};var b=function b(l,m){if(j[l]&&j[l][m]){delete j[l][m];return true}return false};var c=function(n,m){var o=parseInt(m),l=((o===0)||(isNaN(o)))?1:o;if(a[n]===undefined){a[n]=0}else{a[n]+=1}return Math.floor(a[n]/l)};var k={subscribe:function(l){var n=this;var m=function(o){if(!n.isEditing()){n.startEditing(o)}xtdom.stopPropagation(o);xtdom.preventDefault(o)};if(this.isEditable){xtdom.addEventListener(l,"focus",m,true);xtdom.addEventListener(l,"click",m,true);xtdom.addEventListener(l,"mouseup",function(o){xtdom.stopPropagation(o);xtdom.preventDefault(o)},true)}},isFocusable:function(){return(this.isEditable&&((!this._editor.isOptional())||this._editor.isSet()))},isEditing:function(){return this._isEditing},doKeyDown:function(l){},doKeyUp:function(l){},focus:function(){this._editor.getHandle().focus();this.startEditing()},unfocus:function(){this.stopEditing()},cancelEditing:function(){this._editor.getHandle().value=this._legacy;this.stopEditing(true,false)},clear:function(){this._editor.getHandle().value=this.defaultData},update:function(l){if(l===this._legacy){return}if(l.search(/\S/)===-1||(l===this._defaultData)){this._editor.clear(true)}else{this._editor.setModified(l!==this.defaultData);this._editor.set(true)}}};var f=function(p,l,m){var o=p.getHandle(),n;this._editor=p;this.isEditable=!p.getParam("noedit");this.defaultData=m||"";xtdom.setAttribute(o,"type",l);if(n=p.getParam("size")){xtdom.setAttribute(o,"size",n)}o.value=this.defaultData};f.prototype={awake:function(){var l=this._editor.getHandle();var m=this;this.subscribe(l);if(this.isEditable){xtdom.addEventListener(l,"blur",function(n){if(m.isEditing()){m.stopEditing(false,true)}},true)}},load:function(o,m){var l,n;if(o!==-1){l=m.getDataFor(o);n=this._editor.getDefaultData();this._editor.getHandle().value=l||n||"";this._editor.setModified(l!==n);this._editor.set(false)}else{this._editor.clear(false)}},save:function(l){var m=this._editor.getHandle().value;if(m){l.write(m)}},startEditing:function(m){var l,n=xtiger.session(this._editor.getDocument()).load("keyboard");if(!this._isEditing){l=this._editor.getHandle();this._legacy=l.value;this._isEditing=true;this.kbdHandlers=n.register(this,l);n.grab(this,this._editor);if(!this._editor.isModified()){xtdom.focusAndSelect(l)}}},stopEditing:function(l,o){var m,n;if(this._isEditing){m=this._editor.getHandle();n=xtiger.session(this._editor.getDocument()).load("keyboard");this._isEditing=false;n.unregister(this,this.kbdHandlers,m);n.release(this,this._editor);if(!l){this._editor.update(m.value)}if((!o)&&(m.blur)){m.blur()}}}};var h=function(n,l,m){xtdom.setAttribute(n.getHandle(),"type",l);this._editor=n;this.isEditable=!n.getParam("noedit");this.defaultData=m||"";this.dpDone=false};h.prototype={lazyInit:function(m){var l,n=this;if($.datepicker){$(m).on("keydown",function(o){if(o.keyCode===$.ui.keyCode.ESCAPE){n.cancelEditing()}xtdom.stopPropagation(o)});this.jhandle=$(m).datepicker().datepicker("option","onClose",function(){n.onClose()});this.constrained=false}else{alert('datepicker jQuery plugin needed for "date" input field !')}this.dpDone=true},awake:function(){var l,m=this._editor.getHandle();this.subscribe(m);if(this.defaultData==="today"){l=new Date();m.value=this.defaultData=$.datepicker?$.datepicker.formatDate("dd/mm/yy",l):l}else{m.value=this.defaultData}if(!this._editor.getParam("size")){xtdom.setAttribute(m,"size",8)}},onClose:function(){this.stopEditing(false,true)},startEditing:function(o){var m,l,p,n,q=xtiger.session(this._editor.getDocument()).load("keyboard");if(!this._isEditing){n=this._editor.getHandle();this._legacy=n.value;this._isEditing=true;this.kbdHandlers=q.register(this,n);q.grab(this,this._editor);if(!this._editor.isModified()){xtdom.focusAndSelect(n)}if(!this.dpDone){this.lazyInit(n)}if(this.jhandle){m=this._editor.getParam("minDate");l=this._editor.getParam("maxDate");p=this._editor.getParam("beforeShow");if(this.constrained||m||l||p){if(m==="today"){m=$.datepicker.formatDate("dd/mm/yy",new Date())}this.jhandle.datepicker("option","minDate",m||null);if(l==="today"){l=$.datepicker.formatDate("dd/mm/yy",new Date())}this.jhandle.datepicker("option","maxDate",l||null);this.jhandle.datepicker("option","beforeShow",p||null);this.constrained=true}xtiger.util.date.setRegion(this._editor.getParam("date_region"));$(n).datepicker("show")}}},stopEditing:function(l,n){var m=this._editor.getHandle();var o=xtiger.session(this._editor.getDocument()).load("keyboard");if(this._isEditing){this._isEditing=false;o.unregister(this,this.kbdHandlers,m);o.release(this,this._editor);if(!l){this._editor.update(m.value)}if((!n)&&(m.blur)){m.blur()}if(this.jhandle){this.jhandle.datepicker("hide")}}},load:function(o,m){var l,n;if(o!==-1){l=m.getDataFor(o);l=l?($.datepicker?xtiger.util.date.convertDate(this._editor,l,"date_format","date_region"):l):null;n=this.defaultData;this._editor.getHandle().value=l||n||"";this._editor.setModified(l!==n);this._editor.set(false)}else{this.clear(false)}},save:function(l){var m=this._editor.getHandle().value;if(m){m=$.datepicker?xtiger.util.date.convertDate(this._editor,m,"date_region","date_format"):m;l.write(m)}}};var e=function(q,l,o){var p=q.getHandle(),n=q.getParam("name"),m=q.getParam("cardinality");this._editor=q;this._type=l;if(n||(l==="radio")){if(m){o=c(n||"void",m).toString()}n=(n||"").concat(o||"");xtdom.setAttribute(p,"name",n)}if(q.getParam("checked")==="true"){xtdom.setAttribute(p,"checked",true)}else{if(q.getParam("noedit")==="true"){xtdom.addClassName(p,"axel-input-unset")}}};e.prototype={awake:function(){var l=this._editor.getHandle();var m=this;xtdom.addEventListener(l,"click",function(n){if(m._editor.getHandle().checked){m._editor.update(m._editor.getParam("value"))}else{m._editor.update("")}},true)},isFocusable:function(){return true},load:function(q,p){var o,m=this._editor.getHandle(),l=false,n=this._editor.getParam("value");if(-1!==q){o=p.getDataFor(q);l=(o===n);if(!l){name=this._editor.getParam("name");if(name){l=b(name,n);g(name,o)}}if(l){if(!m.checked){m.checked=true;this._editor.set(false);if(this._editor.getParam("noedit")==="true"){xtdom.removeClassName(m,"axel-input-unset")}}}else{this._editor.clear(false)}}else{name=this._editor.getParam("name");if(name){l=b(name,n)}if(l){if(!m.checked){m.checked=true;this._editor.set(false);if(this._editor.getParam("noedit")==="true"){xtdom.removeClassName(m,"axel-input-unset")}}}else{this._editor.clear(false)}}},save:function(l){if(this._editor.getHandle().checked){l.write(this._editor.getParam("value"))}else{l.discardNodeIfEmpty()}},update:function(l){},clear:function(){this._editor.getHandle().checked=false;if(this._editor.getParam("noedit")==="true"){xtdom.addClassName(this._editor.getHandle(),"axel-input-unset")}},focus:function(){this._editor.getHandle().focus()},unfocus:function(){}};var d={onGenerate:function(p,n,m){var l=xtdom.createElement(m,"input"),o=n.getAttribute("param");if(o){if(o.indexOf("type=radio")!==-1){xtdom.setAttribute(l,"type","radio")}else{if(o.indexOf("type=checkbox")!==-1){xtdom.setAttribute(l,"type","checkbox")}}}if(this.getParam("noedit")==="true"){l.disabled=true}p.appendChild(l);return l},onInit:function(p,l,n){var m,o;m=this.getParam("type");if((m==="text")||(m==="password")){this._delegate=new f(this,m,p)}else{if((m==="radio")||(m==="checkbox")){this._delegate=new e(this,m,n?n.getClockCount():undefined)}else{if(m==="date"){this._delegate=new h(this,m,p)}else{xtdom.addClassName(this._handle,"axel-generator-error");xtdom.setAttribute(this._handle,"readonly","1");xtdom.setAttribute(this._handle,"value",'ERROR: type "'+m+'" not recognized by plugin "input"');alert('Form generation failed : fatal error in "input" plugin declaration')}}}if(this.getParam("hasClass")){xtdom.addClassName(this._handle,this.getParam("hasClass"))}},onAwake:function(){this._delegate.awake()},onLoad:function(m,l){this._delegate.load(m,l)},onSave:function(l){if(($(this.getHandle()).attr("disabled")==="disabled")||(this.isOptional()&&!this.isSet())){l.discardNodeIfEmpty()}else{this._delegate.save(l)}},api:{isFocusable:function(){return this._delegate.isFocusable()},focus:function(){if(this._delegate.focus){this._delegate.focus()}},unfocus:function(){if(this._delegate.focus){this._delegate.unfocus()}}},methods:{update:function(l){this._delegate.update(l)},clear:function(l){this._delegate.clear();this.setModified(false);if(this.isOptional()&&this.isSet()){this.unset(l)}},set:function(l){if(l){if(!this.getParam("noedit")){xtiger.editor.Repeat.autoSelectRepeatIter(this.getHandle())}xtdom.removeClassName(this._handle,"axel-repeat-unset")}if(!this._isOptionSet){this._isOptionSet=true;if(this._isOptional){this._handle.disabled=false;this._optCheckBox.checked=true}}},unset:function(l){if(this._isOptionSet){this._isOptionSet=false;if(this._isOptional){this._handle.disabled=true;this._optCheckBox.checked=false}}}}};i.extend(f.prototype,k);i.extend(h.prototype,k);i.plugin.register("input",{filterable:true,optional:true},{type:"text",date_region:"fr",date_format:"ISO_8601"},d)}($axel));(function(a){var b={onGenerate:function(f,e,c){var d=xtdom.createElement(c,"div");xtdom.addClassName(d,"af-html");f.appendChild(d);return d},onInit:function(e,c,d){if(this.getParam("hasClass")){xtdom.addClassName(this._handle,this.getParam("hasClass"))}},onAwake:function(){},onLoad:function(f,e){var c,d;if(e.isEmpty(f)){$(this.getHandle()).html("")}else{d=$(this.getHandle());d.html("");for(c=1;c<f.length;c++){d.append(f[c])}}},onSave:function(c){c.write("HTML BLOB")},api:{},methods:{}};a.plugin.register("html",{filterable:false,optional:false},{key:"value"},b)}($axel));(function(h){var f={dropdownAutoWidth:"bool",minimumResultsForSearch:"int",closeOnSelect:"bool",width:"str",maximumSelectionSize:"int",minimumInputLength:"int"};function b(l){var k,m,p,j="",o="ÀÁÂÃÄÅÒÓÔÕÕÖØÈÉÊËÇÐÌÍÎÏÙÚÛÜÑŠŸŽ",n="AAAAAAOOOOOOOEEEECDIIIIUUUUNSYZ";for(k=0;k<l.length;k++){m=l.charAt(k).toUpperCase();p=o.indexOf(m);j+=(p>=0)?n.charAt(p):m}return j}function e(o,n,l,j,m){var k=n.length;l.push(o.substring(0,m));l.push("<span class='select2-match'>");l.push(o.substring(m,m+k));l.push("</span>");l.push(o.substring(m+k,o.length))}function d(m,j){var n=(m&&m.text)?m.text:"",l=n.indexOf("::"),k;if(n){k=(l!=-1)?n.substr(0,l):n}return k}function g(j,l,r,q,m){var t=(j&&j.text)?j.text:"",o=t.indexOf("::"),k=m||' - <span class="select2-complement">',n="</span>",s=b(r.term),p,u;if(t){u=[];if(o!=-1){if(r.term.length>0){p=b(t).indexOf(s);if(p<o){e(t.substr(0,o),s,u,q,p);u.push(k+t.substr(o+2)+n)}else{if(p>o+1){u.push(t.substr(0,o));u.push(k);e(t.substr(o+2),s,u,q,p-o-2);u.push(n)}else{return t.substr(0,o)+k+t.substr(o+2)+n}}}else{return t.substr(0,o)+k+t.substr(o+2)+n}}else{if(r.term.length>0){p=b(t).indexOf(s);if(p>=0){e(t,s,u,q,p)}else{return t}}else{return t}}return u.join("")}}function c(k,m,l){var j=l.data("key");if(!j){j=b(m);l.data("key",j)}return j.indexOf(b(k))>=0}function a(j,k){var l=k-j.length;return"Entrez au moins "+l+" caractère"+(l==1?"":"s")}var i={onGenerate:function(l,k,j){var m=this.__select2__onGenerate(l,k,j);$(m).wrap('<span class="axel-guard"/>');return m},onAwake:function(){var p=this,o=this.getDefaultData(),m=this.getParam("placeholder"),q=this.getParam("select2_complement"),t=q?' - <span class="'+q+'">':undefined,r=q?function(k,w,u,v){return g(k,w,u,v,t)}:g,l={myDoc:this.getDocument(),formatResult:r,formatSelection:d,matcher:c,formatInputTooShort:a},n,s,j;for(n in f){s=this.getParam("select2_"+n);if(s){if(f[n]==="bool"){j=s==="true"?true:false}else{if(f[n]==="int"){j=parseInt(s)}else{j=s}}l[n]=j}}if(m||(!o)){m=m||"";if(this.getParam("multiple")!=="yes"){$(this._handle).prepend("<option></option>")}if(!o){this._param.values.splice(0,0,m);if(this._param.i18n!==this._param.values){this._param.i18n.splice(0,0,m)}}l.allowClear=true;l.placeholder=m}if(this.getParam("multiple")!=="yes"){if(this.getParam("typeahead")!=="yes"){l.minimumResultsForSearch=-1}}this._setData(o);$(this._handle).select2(l).change(function(k,u){if(!(u&&u.synthetic)){p.update($(this).val())}});$(this._handle).prev(".select2-container").get(0).xttNoShallowClone=true},onLoad:function(k,j){this.__select2__onLoad(k,j);$(this._handle).trigger("change",{synthetic:true})}};h.filter.register("select2",{chain:["onGenerate","onLoad"]},{select2_dropdownAutoWidth:"false",select2_minimumResultsForSearch:"7",select2_closeOnSelect:"false",select2_width:"element",select2_maximumSelectionSize:"-1",select2_minimumInputLength:undefined,},i);h.filter.applyTo({select2:"choice"})}($axel));(function(a){var b={onInstall:function(c){this.terms=this.getParam("blacklist").split(" ");this.editor=a(c);c.bind("axel-update",$.proxy(this.filter,this));a.binding.setValidation(this.editor.get(0),$.proxy(this.filter,this))},methods:{filter:function(){var c,e=this.editor.text(),d=true;for(c=0;c<this.terms.length;c++){if(e===this.terms[c]){d=false;break}}return this.toggleError(d,this.editor.get(0).getHandle(true))}}};a.binding.register("blacklist",{error:true},{blacklist:a.binding.REQUIRED},b)}($axel));(function(a){var b={onInstall:function(d){var c=$('[data-clear="'+this.getVariable()+'"]',this.getDocument());this.editors=a(d);this.ui=c;c.bind("click",$.proxy(this,"execute"));d.bind("axel-update",$.proxy(this,"update"));d.bind("axel-select-all",$.proxy(this,"update"));c.hide()},methods:{execute:function(){this.editors.clear(false);this.ui.hide()},update:function(){var c=this.editors.text();if(c.length>0){this.ui.show()}else{this.ui.hide()}}}};a.binding.register("clear",null,null,b)}($axel));(function(a){var b={onInstall:function(c){this.avoidstr="data-avoid-"+this.getVariable();this.editor=a(c);c.bind("axel-update",$.proxy(this.updateConditionals,this));this.updateConditionals();$(document).bind("axel-content-ready",$.proxy(this,"updateConditionals"))},methods:{updateConditionals:function(f,e){var d,h;var g=this.editor.text();var c=$("body ["+this.avoidstr+"]",this.getDocument());d=(g!="")?c.not("["+this.avoidstr+'*="'+g+'"]'):c.not("["+this.avoidstr+'=""]');h=(g!="")?c.filter("["+this.avoidstr+'*="'+g+'"]'):c.filter("["+this.avoidstr+'=""]');d.find("input").removeAttr("disabled");d.css("color","inherit");h.find("input").attr("disabled","disabled");h.css("color","lightgray")}}};a.binding.register("condition",null,null,b)}($axel));(function(a){function c(d,g){try{return d?$.datepicker.formatDate("dd/mm/yy",$.datepicker.parseDate("yy-mm-dd",d)):g}catch(f){return g}}var b={onInstall:function(g){var e=this.getVariable(),f=$("[data-min-date="+e+"]",g.get(0)),d=$("[data-max-date="+e+"]",g.get(0));this.min=a(f.get(0),true);this.max=a(d.get(0),true);this.min.configure("beforeShow",$.proxy(this.beforeShowMinDate,this));this.max.configure("beforeShow",$.proxy(this.beforeShowMaxDate,this))},methods:{beforeShowMinDate:function(d,e){return{maxDate:c(this.max.text(),null)}},beforeShowMaxDate:function(d,e){return{minDate:c(this.min.text(),null)}}}};a.binding.register("interval",null,null,b)}($axel));(function(a){var b={onInstall:function(c){this.re=new RegExp(this.getParam("regexp")||"");this.editor=a(c);c.bind("axel-update",$.proxy(this.checkRegexp,this));a.binding.setValidation(this.editor.get(0),$.proxy(this.checkRegexp,this))},methods:{checkRegexp:function(){var c=this.re.test(this.editor.text());return this.toggleError(c,this.editor.get(0).getHandle(true))}}};a.binding.register("regexp",{error:true},{regexp:a.binding.REQUIRED},b)}($axel));(function(b){var a={onInstall:function(c){this.editors=b(c);this.handle=c.get(0);if(this.handle.xttPrimitiveEditor){xtiger.cross.log("error",'Failed attempt to attach a "required" binding directly onto a primitive editor')}else{this.handle.xttPrimitiveEditor=this}},methods:{isModified:function(){var c=(this.editors.text()!=="");return c},isFocusable:function(){var c=this.editors.get(1);return(c&&(c!==this))?c.isFocusable():false},focus:function(){var c=this.editors.get(0);if(c){this.editors.get(0).focus()}},unfocus:function(){},can:function(c){return false},getHandle:function(){return this.handle},onInit:function(e,c,d){},onAwake:function(){},load:function(d,c){},save:function(c){}}};b.binding.register("required",{error:true},{required:"true"},a)}($axel));(function(a){var b={onInstall:function(c){this.host=c;this.editors=a(c);$('[data-select="'+this.getVariable()+'"]',this.getDocument()).bind("click",$.proxy(this,"execute"))},methods:{execute:function(){this.editors.apply(function(c){if(!c.disabled){c.checked=true}},true);$(this.host).triggerHandler("axel-select-all",[this])}}};a.binding.register("select",null,null,b)}($axel));(function(a){var b={onInstall:function(c){this.editor=a(c);c.get(0).axel_binding_unique=this;c.bind("axel-update",$.proxy(this.checkSet,this));a.binding.setValidation(this.editor.get(0),$.proxy(this.checkOne,this));this.checkOne()},methods:{checkSet:function(p,f){var g,d,m,h,q=$('body [data-binding~="unique"]',this.getDocument()).filter(function(){return $(this).is(":visible")}),l=a(q),o=l.values(),n=l.length(),c=new Array(n);for(g=0;g<n;g++){if(c[g]){continue}h=0;m=o[g];for(d=g+1;d<n;d++){if(!c[d]&&(o[d]===m)){c[g]=c[d]=true}}}for(g=0;g<n;g++){try{q.get(g).axel_binding_unique.toggleError(!c[g],q.get(g))}catch(k){}}},checkOne:function(l,g){var m=$('body [data-binding~="unique"]',this.getDocument()).filter(function(){return $(this).is(":visible")}),j=a(m),n=this.editor.get(0),d=this.editor.text(),k=j.values(),c=true,f;for(f=0;f<k.length;f++){if((k[f]===d)&&(j.get(f)!==n)){try{m.get(f).axel_binding_unique.toggleError(false,m.get(f))}catch(h){}c=false;break}}return this.toggleError(c,this.editor.get(0).getHandle(true))}}};a.binding.register("unique",{error:true},null,b)}($axel));(function(){function a(c,d,e){var b=$(d);this.doc=e;this.key=c;this.spec=b;if(b.attr("data-command")!=="transform"){xtiger.cross.log("debug","Transforming "+c+" in implicit mode");this.transform();this.implicit=true}else{xtiger.cross.log("debug","Transforming "+c+" in explicit mode");this.implicit=false}this.defaultTpl=this.spec.attr("data-template");this.defaultData=this.spec.attr("data-src")||"";this.ready=false}a.prototype={attr:function(b){if(arguments.length>1){return this.spec.attr(b,arguments[1])}else{return this.spec.attr(b)}},transform:function(c,b){var e,h,d,f=c||this.spec.attr("data-template"),g=b||this.spec.attr("data-src");xtiger.cross.log("debug","transforming physical editor "+this.key);if((f===this.spec.attr("data-template"))&&this.ready){this.reset()}else{if(f){if(f!=="#"){e=f.substring(f.lastIndexOf("/")+1);if(e.indexOf("?")!==-1){e=e.substring(0,e.indexOf("?"))}}d={bundlesPath:$axel.command.defaults.bundlesPath,enableTabGroupNavigation:true};h=(f==="#")?$axel(this.spec).transform(d):$axel(this.spec).transform(f,d);if(g){h.load(g);this.spec.attr("data-src",g)}if(this.spec.attr("data-cancel")){$(window).bind("unload",$.proxy(this,"reportCancel"))}if(h.transformed()){if(!this.implicit){xtiger.cross.log("debug",'[[[ installing bindings from "transform" command');$axel.binding.install(this.doc,this.spec.get(0),this.spec.get(0));xtiger.cross.log("debug",']]] installed bindings from "transform" command');xtiger.cross.log("debug",'<<< installing commands from "transform" command');$axel.command.install(this.doc,this.spec.get(0).firstChild,this.spec.get(0).lastChild);xtiger.cross.log("debug",'>>> installed commands from "transform" command')}this.spec.attr("data-template",f);this.spec.addClass("edition").addClass(e);this.ready=true}else{this.ready=false}}else{$axel.error('Missing data-template attribute to generate the editor "'+this.key+'"')}}},reset:function(b){if(b&&this.defaultTpl&&(this.defaultTpl!==this.spec.attr("data-template"))){this.attr("data-src",this.defaultData);this.transform(this.defaultTpl)}else{$axel(this.spec).load("<Reset/>");$('*[class*="af-invalid"]',this.spec.get(0)).removeClass("af-invalid");$('*[class*="af-required"]',this.spec.get(0)).removeClass("af-required")}},trigger:function(b,c){this.spec.triggerHandler(b,[this,c])},serializeData:function(){return $axel(this.spec).xml()},reportCancel:function(b){if(!this.hasBeenSaved){$.ajax({url:this.spec.attr("data-cancel"),data:{transaction:this.spec.attr("data-transaction")},type:"GET",async:false})}}};$axel.command.register("transform",a,{check:false})}());(function(){function a(e,d,f){var i="width="+d+",height="+f+",status=yes,resizable=yes,scrollbars=yes,title="+e,g;if(xtiger.cross.UA.IE){g=window.open("about:blank")}else{g=window.open(null,e,i)}return g}function c(g){var f=g.replace(/</g,"&lt;");var e=f.replace(/\n/g,"<br/>");var d=e.replace(/ /g,"&nbsp;");return d}function b(d,e){this.key=d;$(e).bind("click",$.proxy(this,"execute"));xtiger.cross.log("debug","installing dump command")}b.prototype={execute:function(f){var e=$axel.command.getEditor(this.key),g,d,h;if(e){prolog='<?xml version="1.0"?>\n';g=e.serializeData();h=a("XML",800,600).document;h.open();h.writeln(c(prolog));h.writeln(c(g));h.close()}}};$axel.command.register("dump",b,{check:true})}());(function(){function a(c,d){var b=$(d);this.label={preview:b.attr("data-preview-label")||b.text(),edit:b.attr("data-edit-label")||"Edit"};b.bind("click",$.proxy(this,"execute"))}a.prototype={execute:function(c){var b=$("body"),d=!b.hasClass("preview");$(c.target).text(this.label[d?"edit":"preview"]);b.toggleClass("preview",d)}};$axel.command.register("preview",a)}());(function(){function a(b,c){this.key=b;$(c).bind("click",$.proxy(this,"execute"))}a.prototype={execute:function(d){var b,c=$axel.command.getEditor(this.key);if(c){c.reset();b=c.attr("data-validation-output");if(b){$("#"+b).removeClass("af-validation-failed")}}}};$axel.command.register("reset",a,{check:true})}());(function(){function a(b,c,d){this.doc=d||document;this.spec=$(c);this.key=b;this.spec.bind("click",$.proxy(this,"execute"))}a.prototype=(function(){function h(k){return $("error > message",k.responseXML).size()>0}function i(l){var k=$("error > message",l.responseXML).text();return k||l.status}function c(l){var k=$("success > message",l.responseXML).text();return k}function e(m){var n=m.responseText.indexOf("<payload>"),k,l=m.responseText;if(n!=-1){k=m.responseText.indexOf("</payload>");if(k!=-1){l=m.responseText.substr(n+9,k-n-9)}}return l}function f(){this.swap.remove();this.fragment.show()}function d(){var k=$axel.command.getEditor(this.key);if(k){k.reset();this.swap.remove();this.fragment.show()}else{$axel.error("Cannot find the document editor to reset",this.errTarget)}}function g(q){var p=q.responseText,l=q.status;var o="Error ! Result code : "+l;var n="";var k=p.match("<title>(.*)</title>","m");if(k){n="\n"+k[1]}k=p.match("<h2>(.*)</h2>","m");if(k){n=n+"\n"+k[1]}else{if($("div.message",q.responseXML).size()>0){n=n+"\n"+$("div.message",q.responseXML).get(0).textContent;if($("div.description",q.responseXML).size()>0){n=n+"\n"+$("div.description",q.responseXML).get(0).textContent}}}return o+n}function j(m,k,q){var p=q.getResponseHeader("Location"),n,l,o;if((q.status===201)||(q.status===200)){if(p){window.location.href=p}else{o=c(q);if(o){alert(o)}n=this.spec.attr("data-replace-type")||"all";if(n==="event"){$axel.command.getEditor(this.key).spec.triggerHandler("axel-save-done",[this,q])}else{l=$("#"+this.spec.attr("data-replace-target"));if(l.length>0){if(n==="all"){l.replaceWith(e(q))}else{if(n==="swap"){this.swap=$(e(q));l.after(this.swap);l.hide();this.fragment=l;$('button[data-command="continue"]',this.swap).bind("click",$.proxy(f,this));$('button[data-command="reset"]',this.swap).bind("click",$.proxy(d,this))}else{if(n==="append"){l.append(e(q))}}}$axel.command.getEditor(this.key).trigger("axel-save-done",this)}else{xtiger.cross.log("error",'missing "data-replace-target" attribute to report "save" command success')}}}}else{$axel.error("Unexpected response from server ("+q.status+"). Save action may have failed",this.errTarget)}}function b(n,k,m){var l;if(k==="timeout"){$axel.error("Save action taking too much time, it has been aborted, however it is possible that your page has been saved",this.errTarget)}else{if(n.status===409){l=n.getResponseHeader("Location");if(l){window.location.href=l}else{$axel.error(i(n),this.errTarget)}}else{if(h(n)){$axel.error(i(n),this.errTarget)}else{if(n.responseText.search("Error</title>")!==-1){$axel.error(g(n),this.errTarget)}else{if(m){$axel.error("Exception : "+m.name+" / "+m.message+"\n (line "+m.lineNumber+")",this.errTarget)}else{$axel.error('Error while connecting to "'+this.url+'" ('+n.status+")",this.errTarget)}}}}}}return{execute:function(m){var r=$axel.command.getEditor(this.key),l=true,k,s,o,p,t,q,n=this.spec.attr("data-save-confirm");if(r){if(!n||confirm(n)){url=this.spec.attr("data-src")||r.attr("data-src")||".";if(url){if(r.attr("data-validation-output")||this.spec.attr("data-validation-output")){q=$axel(r.spec.get(0));l=$axel.binding.validate(q,r.attr("data-validation-output")||this.spec.attr("data-validation-output"),this.doc,r.attr("data-validation-label")||this.spec.attr("data-validation-label"))}if(l){p=r.serializeData();if(p){k=r.attr("data-method")||this.spec.attr("data-method")||"post";o=r.attr("data-transaction")||this.spec.attr("data-transaction");if(o){url=url+"?transaction="+o}$.ajax({url:url,type:k,data:p,dataType:"xml",cache:false,timeout:50000,contentType:"application/xml; charset=UTF-8",success:$.proxy(j,this),error:$.proxy(b,this)});r.hasBeenSaved=true}else{$axel.error("The editor did not generate any data")}}}else{$axel.error("The command does not know where to send the data")}}}else{$axel.error("There is no editor associated with this command")}}}}());$axel.command.register("save",a,{check:false})}());(function(){function a(c,d){var b=$(d);this.key=c;this.formid=b.attr("data-form");if(this.formid&&($("form#"+this.formid).length>0)){d.disabled=false;b.bind("click",$.proxy(this,"execute"))}else{d.disabled=true;$axel.error('Missing or invalid data-form attribute in submit command ("'+this.formid+'")')}}a.prototype={execute:function(){var c=$("#"+this.formid),e=$("#"+this.formid+' > input[name="data"]'),b=$axel.command.getEditor(this.key);if(b&&(c.length>0)&&(e.length>0)){e.val(b.serializeData());c.submit()}else{$axel.error("Missing editor or malformed form element to submit data")}}};$axel.command.register("submit",a,{check:true})}());(function(){function a(b,d,e){var c=$(d);this.doc=e;this.key=b;this.errid=c.attr("data-validation-output");this.cssrule=c.attr("data-validation-label");if(this.errid){c.bind("click",$.proxy(this,"execute"))}else{xtiger.cross.log("error",'Missing "data-validation" attribute in "validation" command')}}a.prototype={execute:function(d){var c,b=$axel.command.getEditor(this.key);if(b){fields=$axel(b.spec.get(0));$axel.binding.validate(fields,this.errid,this.doc,this.cssrule)}}};$axel.command.register("validate",a,{check:true})}());(function(){function a(b,c,d){this.doc=d||document;this.spec=$(c);this.key=b;this.spec.bind("click",$.proxy(this,"execute"))}a.prototype=(function(){function h(i){return $("error > message",i.responseXML).size()>0}function e(j){var i=$("error > message",j.responseXML).text();return i||j.status}function b(o){var n=o.responseText,j=o.status;var l="Error ! Result code : "+j;var k="";var i=n.match("<title>(.*)</title>","m");if(i){k="\n"+i[1]}i=n.match("<h2>(.*)</h2>","m");if(i){k=k+"\n"+i[1]}else{if($("div.message",o.responseXML).size()>0){k=k+"\n"+$("div.message",o.responseXML).get(0).textContent;if($("div.description",o.responseXML).size()>0){k=k+"\n"+$("div.description",o.responseXML).get(0).textContent}}}return l+k}function f(k,i,o){var n=o.getResponseHeader("Location"),m,j,l;if(o.status===200){if(n){window.location.href=n}else{m=this.spec.attr("data-replace-type")||"all";j=$("#"+this.spec.attr("data-replace-target"));if(j.length>0){if(m==="all"){l=j.replaceWith(o.responseText)}else{if(m==="swap"){if(this.swap){this.swap.replaceWith(o.responseText)}else{this.swap=$(o.responseText);j.after(this.swap);j.hide();this.fragment=j}l=this.swap}}$('button[data-command="proceed"]',l).bind("click",$.proxy(g,this));$('button[data-command="cancel"]',l).bind("click",$.proxy(c,this))}else{$axel.error('Bad page design to complete delete action ("data-replace-target" error)')}}}else{$axel.error("Unexpected response from server ("+o.status+"). Delete action may have failed")}}function d(l,i,k){var j;if(i==="timeout"){$axel.error("Delete action taking too much time, it has been aborted, however it is possible that the resource has been deleted",this.errTarget)}else{if(h(l)){$axel.error(e(l),this.errTarget)}else{if(l.responseText.search("Error</title>")!==-1){$axel.error(b(l),this.errTarget)}else{if(k){$axel.error("Exception : "+k.name+" / "+k.message+"\n (line "+k.lineNumber+")",this.errTarget)}else{$axel.error("Error while talking to server ("+l.status+")",this.errTarget)}}}}}function g(){var i,j=$axel.command.getEditor(this.key);if(j){i=j.attr("data-src");$.ajax({url:i,type:"delete",cache:false,timeout:10000,success:$.proxy(f,this),error:$.proxy(d,this)})}}function c(){if(this.swap){this.swap.remove();delete this.swap}if(this.fragment){this.fragment.show()}}return{execute:function(k){var i,j=$axel.command.getEditor(this.key);if(j){i=j.attr("data-src");if(i){if(!/\/$/.test(i)){i+="/"}i+=(this.spec.attr("data-confirm-action")||"delete");$.ajax({url:i,type:"get",cache:false,timeout:10000,success:$.proxy(f,this),error:$.proxy(d,this)})}else{$axel.error('Missing "data-src" parameter on the editor')}}}}}());$axel.command.register("delete",a,{check:true})}());(function(){function a(b,c){this.spec=$(c);this.key=b;this.spec.bind("click",$.proxy(this,"execute"))}a.prototype={execute:function(b){$axel.command.getEditor(this.key).trigger(this.spec.attr("data-trigger-event"),this)}};$axel.command.register("trigger",a,{check:false})}());(function(){function a(b,c){this.spec=$(c);this.key=b;this.spec.bind("click",$.proxy(this,"execute"));$("#"+b).bind("axel-cancel-edit",$.proxy(this,"dismiss"));$("#"+b).bind("axel-save-done",$.proxy(this,"saved"))}a.prototype={execute:function(c){var b;if(!this.done){$axel.command.getEditor(this.key).transform()}else{if(this.cleanOnShow){$axel.command.getEditor(this.key).reset();this.cleanOnShow=false}}if($axel("#"+this.key).transformed()){this.done=true;this.spec.hide();b=this.spec.attr("data-target-modal");if(b){$("#"+b).modal("show").one("hidden",$.proxy(this,"hidden"))}else{$("#"+this.spec.attr("data-target-ui")).show()}}},dismiss:function(c){var b;b=this.spec.attr("data-target-modal");if(b){$("#"+b).modal("hide")}else{this.spec.show();$("#"+this.spec.attr("data-target-ui")).hide()}},saved:function(b){this.dismiss();this.cleanOnShow=true},hidden:function(){this.spec.show()}};$axel.command.register("add",a,{check:true})}());